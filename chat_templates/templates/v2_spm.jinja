{#- Default system message if no system prompt is passed. #}
{%- set default_system_message = '' %}

{#- Begin of sequence token. #}
{{- bos_token }}

{#- Handle system prompt if it exists. #}
{#- System prompt supports text content or text chunks. #}
{%- if messages[0]['role'] == 'system' %}
    {%- if messages[0]['content'] is string %}
        {%- set system_message = messages[0]['content'] %}
    {%- else %}        
        {%- for block in messages[0]['content'] %}
            {%- if block['type'] == 'text' %}
                {% set system_message = system_message + block['text'] %}
            {%- else %}
                {{- raise_exception('Only text chunks are supported in system message contents.') }}
            {%- endif %}
        {%- endfor %}
    {%- endif %}
    {%- set loop_messages = messages[1:] %}
{%- else %}
    {%- set system_message = default_system_message %}
    {%- set loop_messages = messages %}
{%- endif%}

{#- Tools definition #}
{%- set tools_definition = '' %}
{%- set has_tools = false %}
{%- if tools is defined and tools is not none and tools|length > 0 %}
    {%- set has_tools = true %}
    {%- set tools_definition = '[AVAILABLE_TOOLS] ' + (tools| tojson) + '[/AVAILABLE_TOOLS]' %}
{%- endif %}

{#- Checks for alternating user/assistant messages. #}
{%- set ns = namespace(index=0, max_idx_user=-1, add_space=false, prev_tool=false) %}
{%- for message in loop_messages %}
    {%- if message.role == 'user' or (message.role == 'assistant' and (message.tool_calls is not defined or message.tool_calls is none or message.tool_calls | length == 0)) %}
        {%- if (message['role'] == 'user') != (ns.index % 2 == 0) %}
            {{- raise_exception('After the optional system message, conversation roles must alternate user/assistant/user/assistant/...') }}
        {%- endif %}
        {%- set ns.index = ns.index + 1 %}
        {%- if message.role == 'user' %}
            {%- set ns.max_idx_user = ns.max_idx_user + 1 %}
        {%- endif %}
    {%- endif %}
{%- endfor %}


{%- set ns.index = 0 %}
{#- Handle conversation messages. #}
{%- for message in loop_messages %}
    {#- User messages supports text content. #}
    {%- if message['role'] == 'user' %}
        {#- Add tool definition to the last user message. #}
        {%- if (ns.index == ns.max_idx_user) and has_tools %}
            {{- tools_definition }}
        {%- endif %}
        {{- '[INST] ' }}
        {#- Add system message to the last user message. #}
        {%- if (ns.index == ns.max_idx_user) and system_message != '' %}
            {{- system_message + '\n\n' }}
        {%- endif %}

        {%- if message['content'] is string %}
            {{- message['content']}}
        {%- elif message['content'] | length > 0 %}
            {%- for block in  message['content'] %}
                {%- if block['type'] == 'text' %}
                    {{- block['text'] }}
                {%- else %}
                    {{- raise_exception('Only text chunks are supported in user message content.') }}
                {%- endif %}
            {%- endfor %}
        {%- else %}
            {{- raise_exception('User message must have a string or a list of chunks in content') }}
        {%- endif %}
        {{- '[/INST]' }}
        {%- if loop.index < loop.length %}
            {%- set ns.add_space=true %}
        {%- endif %}
        {%- set ns.prev_tool=false %}

    {#- Assistant messages supports text content or text chunks. #}
    {%- elif message['role'] == 'assistant' %}
        {%- if message['content'] is not none and message['content'] | length > 0 and message['tool_calls'] is defined and message['tool_calls'] is not none and message['tool_calls']|length > 0 %}
            {{- raise_exception('Assistant message cannot have both content and tool calls.') }}
        {%- endif %}

        {%- if message['content'] is string and message['content'] != '' %}
            {%- if ns.add_space %}
                {{- ' ' }}
                {%- set ns.add_space=false %}
            {%- endif %}
            {{- message['content'] }}
            {{- eos_token }}
        {%- elif message['content'] | length > 0 %}
            {%- if ns.add_space %}
                {{- ' ' }}
                {%- set ns.add_space=false %}
            {%- endif %}
            {%- for block in message['content'] %}
                {%- if block['type'] == 'text' %}
                    {{- block['text'] }}
                {%- else %}
                    {{- raise_exception('Only text chunks are supported in assistant message contents.') }}
                {%- endif %}
            {%- endfor %}
            {{- eos_token }}
        {%- elif message['tool_calls'] is defined and message['tool_calls'] is not none and message['tool_calls']|length > 0 and ns.index > ns.max_idx_user %}
            {%- if ns.add_space %}
                {%- set ns.add_space=false %}
            {%- endif %}
            {{- '[TOOL_CALLS] [' }}
            {%- for tool in message['tool_calls'] %}
                {%- set name = tool['function']['name'] %}
                {%- set arguments = tool['function']['arguments'] %}
                {%- if arguments is not string %}
                    {%- set arguments = arguments|tojson|safe %}
                {%- elif arguments == '' %}
                    {%- set arguments = '{}' %}
                {%- endif %}
                {{- '{"name": "' + name + '", "arguments": ' + arguments + '}' }}
                {%- if loop.length > 1 and loop.index < loop.length %}
                    {{- ', ' }}
                {%- endif %}
            {%- endfor %}
            {{- ']' }}
            {{- eos_token }}
        {%- elif message['tool_calls'] is defined and message['tool_calls'] is not none and message['tool_calls']|length > 0 and ns.index <= ns.max_idx_user %}
        {%- else %}
            {{- raise_exception('Assistant message must have a string or a list of chunks in content or a list of tool calls.') }}
        {%- endif %}
        {%- set ns.prev_tool=false %}

    
    {#- Tool messages supports int, float or text content. #}
    {%- elif message['role'] == 'tool' and ns.index > ns.max_idx_user %}
        {%- if ns.add_space %}
            {%- if not ns.prev_tool %}
                {{- ' '}}
            {%- endif %}
            {%- set ns.add_space=false %}
        {%- endif %}
        {# Try to parse 'content' as int or float if possible #}
        {%- set tool_content = message['content']|string %}
        {# Try to parse as int #}
        {%- set parsed_int = message['content']|int %}
        {% if parsed_int|string == message['content'] %}
            {%- set tool_content = parsed_int %}
        {# If int fails, try to parse as float #}
        {%- else %}
            {%- set parsed_float = message['content']|float %}
            {%- if parsed_float|string == message['content'] %}
                {%- set tool_content = parsed_float %}
            {%- endif %}
        {%- endif %}
        
        {%- if message['name'] is undefined or message['name'] is none %}
            {{- raise_exception('Tool message must have a name.') }}
        {%- endif %}

        {%- set tool_message = {'name': message['name'], 'content': tool_content} %}
        
        {{- '[TOOL_RESULTS] [' + (tool_message|tojson) + '][/TOOL_RESULTS]' }}
        {%- set ns.prev_tool=true %}
        {%- set ns.add_space=true %}
        

    {#- Raise exception for unsupported roles. #}
    {%- elif message['role'] != 'tool' or ns.index > ns.max_idx_user %}
        {{- raise_exception('Only user, assistant and tool roles are supported, got ' + message['role']) }}
    {%- endif %}

    {%- if message['role'] == 'user' %}
        {%- set ns.index = ns.index + 1 %}
    {%- endif %}
{%- endfor %}
